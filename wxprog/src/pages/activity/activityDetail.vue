<style lang="less">
.header-img {
  width: 100%;
  height: 400rpx;
}

.header-img image {
  width: 100%;
  height: 100%;
}

.content-box {
  width: 100%;
}

.content-top {
  width: 686rpx;
  border-bottom: 2rpx solid #e5e3e3;
  padding: 20rpx 32rpx 27rpx 32rpx;
}

.content-title {
  width: 100%;
  font-family: PingFangSC-Medium;
  font-size: 32rpx;
  color: #040404;
  line-height: 44rpx;
}

.bottom-repeat {
  width: 100%;
  height: 38rpx;
  margin-top: 18rpx;
  font-size: 24rpx;
  color: #999999;
  line-height: 38rpx;
}

.bottom-repeat image:nth-child(1) {
  width: 32rpx;
  height: 26rpx;
  float: left;
  margin-top: 6rpx;
}

.bottom-repeat image:nth-child(3) {
  width: 26rpx;
  height: 26rpx;
  float: left;
  margin-top: 6rpx;
}

.information-number,
.information-share {
  float: left;
  line-height: 38rpx;
  margin: 0 36rpx 0 16rpx;
}

.repeat {
  width: 44rpx;
  height: 38rpx;
  float: right;
  margin-top: -8rpx;
}

.list-box {
  width: 686rpx;
  height: 98rpx;
  border-bottom: 2rpx solid #e5e3e3;
  line-height: 98rpx;
  font-size: 30rpx;
  padding: 0 32rpx;
}

.list-box image {
  margin-right: 26rpx;
}

.list-box .image2 {
  margin-right: 29rpx;
  margin-left: 3rpx;
}

.list-price {
  width: 44rpx;
  height: 40rpx;
}

.list-time {
  width: 44rpx;
  height: 44rpx;
}

.list-area {
  width: 38rpx;
  height: 48rpx;
}

.list-box text {
  color: #4a4a4a;
}

.list-price {
  margin-top: 29rpx;
  float: left;
}

.list-time {
  margin-top: 27rpx;
  float: left;
}

.list-area {
  margin-top: 25rpx;
  float: left;
}

.detail-nav {
  height: 96rpx;
  float: left;
  text-align: center;
  flex: 1;
  // border-bottom: 2rpx solid #A90202;
}

.comment-nav {
  flex: 1;
  height: 96rpx;
  float: left;
  text-align: center;
}

.select-red {
  color: #a90202;
  border-bottom: 2px solid #a90202;
}

.detail-nav text,
.comment-nav text {
  padding: 28rpx 20rpx;
  height: 96rpx;
}

.detail-box {
  width: 686rpx;
  padding: 32rpx 32rpx 0rpx 32rpx;
  font-family: PingFangSC-Medium;
  font-size: 30rpx;
  color: #000000;
  position: relative;
}

.detail-p {
  font-size: 30rpx;
  margin-left: -14rpx;
}

.detail-people {
  font-size: 30rpx;
  color: #4a4a4a;
  letter-spacing: 0;
  line-height: 32px;
  margin-bottom: 20rpx;
}

.detail-spot {
  float: left;
  width: 686rpx;
  padding-bottom: 162rpx;
}

.detail-spot label {
  margin: 18rpx 0;
  width: 100%;
  float: left;
}

.detail-spot label image {
  width: 100%;
}

.fixed-box {
  width: 100%;
  height: 96rpx;
  position: fixed;
  bottom: 0;
  left: 0;
}

.fixed-left {
  height: 100%;
  width: 344rpx;
  float: left;
  background: #fff;
  border-top: 2rpx solid #a90202;
}

.zh-fixed-left {
  width: 284rpx;
}

.fixed-right {
  height: 100%;
  width: 406rpx;
  background: #a90202;
  color: #fff;
  text-align: center;
  line-height: 94rpx;
  font-size: 32rpx;
  float: left;
  font-family: PingFangSC-Medium;
  border-top: 2rpx solid #a90202;
}

.zh-fixed-right {
  width: 466rpx;
}

.custom,
.collect {
  width: 75rpx;
  height: 100%;
  float: left;
  font-size: 24rpx;
  font-family: PingFangSC-Medium;
  color: #757575;
  line-height: 24rpx;
}

.contact-box {
  width: 140rpx;
  height: 100%;
  float: left;
}

.collect {
  width: 204rpx;
}

.custom {
  padding: 0;
  width: 140rpx;
  background-color: #ffffff;
  box-sizing: static;
  border-radius: 0;
  border: 0;
  text-align: center;
  position: absolute;
}

.zh-fixed-left .collect {
  width: 144rpx;
}

.collect {
  text-align: center;
}

.custom image {
  width: 50rpx;
  height: 38rpx;
  margin-bottom: 4rpx;
  margin-top: 14rpx;
  margin-left: 45rpx;
  margin-right: 45rpx;
}

.collect image {
  width: 38rpx;
  height: 38rpx;
  margin-top: 14rpx;
  margin-bottom: 4rpx;
  margin-left: 83rpx;
  margin-right: 83rpx;
}

.zh-fixed-left .collect {
  width: 144rpx;
}

.zh-fixed-left .collect image {
  margin-left: 53rpx;
  margin-right: 53rpx;
}

.contact {
  width: 78rpx;
  font-size: 24rpx;
  float: left;
  background: #ffffff;
}

button::after {
  border: none;
}

.share-button {
  width: 100rpx;
  height: 58rpx;
  background: #fff;
  float: right;
  padding: 10rpx 28rpx 10rpx 28rpx;
  margin: -10rpx -28rpx 0 0;
}

.red {
  color: #a90202;
}

.comment-box {
  width: 718rpx;
  padding: 32rpx 0 28rpx 32rpx;
  float: left;
}

.comment-top {
  width: 100%;
  height: 42rpx;
  line-height: 42rpx;
  font-family: PingFangSC-Medium;
  font-size: 32rpx;
  color: #4a4a4a;
}

.write-comment {
  float: right;
  color: #5aadff;
  padding-right: 32rpx;
}

.write-comment image {
  width: 52rpx;
  height: 52rpx;
  margin-top: -5rpx;
  margin-right: 8rpx;
  float: left;
}

.comment-content {
  float: left;
  width: 100%;
}

.main-take {
  font-size: 28rpx;
  line-height: 40rpx;
}

.fixed-comment {
  width: 100%;
  height: 118rpx;
  position: fixed;
  bottom: 0;
  border-top: 2rpx solid #e5e3e3;
  background: #fff;
}

.fixed-comment-box {
  width: 686rpx;
  height: 76rpx;
  margin: 22rpx 0 0 32rpx;
  border-radius: 200rpx;
  background: #eff1f4;
  line-height: 76rpx;
  font-family: PingFangSC-Medium;
  font-size: 30rpx;
  color: #9b9b9b;
}

.put-comment {
  width: 52rpx;
  height: 52rpx;
  float: left;
  margin-left: 30rpx;
  margin-top: 12rpx;
  margin-right: 8rpx;
}

.friend-share {
  width: 44rpx;
  height: 38rpx;
  padding: 0;
  background: #fff;
  margin: 0;
  float: right;
  border-radius: 0;
}

.content-box .bottom-repeat .friend-share image {
  width: 44rpx;
  height: 38rpx;
  margin: 0;
}

.list-nav {
  display: flex;
}

.is-end {
  background: #9b9b9b;
  border-top: 2rpx solid #9b9b9b;
}

.hui-border {
  border-top: 2rpx solid #9b9b9b;
}

.is-fixed {
  position: fixed;
  top: 0;
  background: #fff;
  z-index: 88;
}

.list-box-time {
  padding-right: 0;
}

.list-box-english {
  height: 109rpx;
  line-height: 40rpx;
  padding-top: 29rpx;
  padding-right: 32rpx;
}

.no-more {
  width: 686rpx;
  height: 32rpx;
  padding: 36rpx 32rpx 48rpx 32rpx;
  float: left;
}

.no-more text {
  width: 100%;
  height: 2rpx;
  float: left;
  background: #e5e3e3;
  margin-top: 15rpx;
}

.no-more-content {
  font-size: 22rpx;
  color: #9b9b9b;
  width: 220rpx;
  line-height: 32rpx;
  position: absolute;
  background: #ffffff;
  top: 35rpx;
  left: 275rpx;
  text-align: center;
}

.list-box-next {
  padding-bottom: 100rpx;
}

.list-time-english {
  margin-top: 18rpx;
}
</style>
<template>
  <view class="container">
    <scroll-view scroll-y="true" bindscroll="scroll" style="height: 100vh;" bindscrolltolower="scrolltolower" scroll-top="{{top}}">
    <view class="header-img"><image binderror="imgErr"   mode="aspectFill" src="{{option.cover}}"></image></view>
    <view class="content-box">
        <view class="content-top">
            <view class="content-title">{{option.name}}</view>
            <view class="bottom-repeat">
                <image  mode="aspectFill" src="http://pc1u34h1m.bkt.clouddn.com/see@3x.png"></image>
                <view class="information-number">{{option.pageViews}}</view>
                <image  mode="aspectFill" src="http://pc1u34h1m.bkt.clouddn.com/collect-grey@3x.png"></image>
                <view class="information-share">{{option.likeNumber}}</view>
                <button open-type="share" class="friend-share"><image  mode="aspectFill" src="http://pc1u34h1m.bkt.clouddn.com/share%402x.png"></image></button> 
            </view>
        </view>
        <view class="list-box" catchtap="navigateto">
            <image mode="aspectFill" class="list-price" src="http://pc1u34h1m.bkt.clouddn.com/cost%402x.png"></image>
            <text>{{option.priceRangeDesc=='￥免费'?language=='ZH'?'免费':'Free':option.priceRangeDesc}}</text>
        </view>
        <view class="list-box list-box-time {{isLang?'list-box-english':''}}">
            <image mode="aspectFill" class="list-time {{isLang?'list-time-english':''}}" src="http://pc1u34h1m.bkt.clouddn.com/history-search%402x.png"></image>
            <text>{{option.activityStartTime+' ~ '+option.activityEndTime}}</text>
        </view>
        <view class="list-box {{isFixed?'list-box-next':''}}"  catchtap="toMap">
            <image mode="aspectFill" class="list-area image2" src="http://pc1u34h1m.bkt.clouddn.com/map%402x.png"></image>
            <text>{{option.naddress}}</text>
        </view>
        <view class="list-box list-nav {{isFixed?'is-fixed':''}}">
            <view catchtap="selectContent" data-set="{{true}}" class="detail-nav"><text class="{{isRed?'select-red':''}}">{{language=='ZH'?'详情':'Overview'}}</text></view>
            <view catchtap="selectContent" data-set="{{false}}" class="comment-nav"><text class="{{!isRed?'select-red':''}}">{{language=='ZH'?'评论':'Discussion'}}</text></view>
        </view>
        <view class="detail-box" wx:if="{{isRed}}">
           <view class="detail-spot">
              <label wx:for="{{option.introduction}}" wx:key="{{index}}">
                <view style="word-wrap:break-word" wx:if="{{item.type=='text'}}">{{item.content}}</view>
               <image binderror="imgsErr" data-set="{{index}}" wx:if="{{item.type=='img'}}" mode="aspectFill" src="{{item.content}}"></image>
              </label>
           </view>
        </view>
        <view class="comment-box {{newsOptionItems.length==0?'no-news':''}}" wx:if="{{!isRed}}">
          <view class="comment-top">{{language=='ZH'?'评论':'Comments'}}({{newsOption.total}})<view class="write-comment" catchtap="openReplay"><image mode="aspectFill" src="http://pc1u34h1m.bkt.clouddn.com/edit%402x.png"></image>{{language=='ZH'?'发表评论':'Add a comment'}}</view></view>
          <view class="comment-content">
            <newsContent :newsContentOption.sync="newsOptionItems"></newsContent>
          </view>
        </view>
        <view wx:if="{{!isMore&&!isRed}}" class="no-more"> 
            <text></text>
            <view class="no-more-content">{{language=="ZH"?'没有更多评论了':'No more comments'}}</view>
          </view>
    </view>
    <view wx:if="{{isRed}}" class="fixed-box">
        <view class="fixed-left {{language=='ZH'?'zh-fixed-left':''}} {{activityIsEnd||!isJoinActivity?'hui-border':''}}">
            <view class="contact-box">
              <button disabled="{{isLogin}}" open-type="contact" class="custom">
                <image mode="aspectFill" src="http://pc1u34h1m.bkt.clouddn.com/consult%402x.png"></image>
                {{language=='ZH'?'咨询':'Consult'}}
              </button>
            </view>
            <view catchtap="getSelect" class="collect {{isSollect==true?'red':''}}">
            <image mode="aspectFill" wx:if="{{isSollect==false}}" src="http://pc1u34h1m.bkt.clouddn.com/collect-grey%403x.png"></image>
            <image mode="aspectFill" class="select-icon" wx:if="{{isSollect==true}}" src="http://pc1u34h1m.bkt.clouddn.com/collected_s%403x.png"></image>
            {{isSollect?language=='ZH'?'已收藏':'Add to favorites':language=='ZH'?'收藏':'Add to favorites'}}</view>
        </view>
        <view class="fixed-right {{language=='ZH'?'zh-fixed-right':''}} {{activityIsEnd||!isJoinActivity?'is-end':''}}" catchtap="navigateto">{{activityIsEnd?language=='ZH'?'活动已结束':'End of the activity':isJoinActivity?language=='ZH'?'立即报名':'Book now':language=='ZH'?'报名已结束':'Book over'}}</view>
    </view>
    <view wx:if="{{!isRed&&isPut}}" class="fixed-comment">
      <view class="fixed-comment-box" catchtap="openReplay">
        <image mode="aspectFill" class="put-comment" src="http://pc1u34h1m.bkt.clouddn.com/edit-grey.png"></image>{{language=='ZH'?'发表评论':'Add a comment'}}
      </view>
    </view>
    <writeReplay :replayData.sync='replayData' wx:if="{{isReplay}}"></writeReplay>
    <writeComment :commentData.sync="commentData" wx:if="{{isWriteComment}}"></writeComment>
    <report wx:if="{{isReportOpen}}"></report>
    </scroll-view>
  </view>
</template>

<script>
import wepy from 'wepy';
import Toast from 'wepy-com-toast';
import newsContent from '../../components/newsContent';
import writeReplay from '../../components/writeReplay';
import writeComment from '../../components/writeComment';
import report from '../../components/report';
import noMore from '../../components/noMore';
import {
  activityDetail,
  collection,
  putOder,
  cancelCollection,
  relationList
} from '../../api/index';
import { getTime } from '../../utils/filter';

export default class ActivityDetail extends wepy.page {
  config = {};
  components = {
    newsContent: newsContent,
    writeReplay: writeReplay,
    report: report,
    writeComment: writeComment,
    noMore: noMore
  };

  data = {
    isRed: true,
    isSelect: false,
    isSollect: false,
    isReplay: false,
    isReportOpen: false,
    isWriteComment: false,
    activityId: 0,
    option: {},
    language: 'ZH',
    isPut: true,
    activityIsEnd: false,
    isFixed: false,
    scrollHeight: 0,
    top: 0,
    replayData: {},
    commentData: {},
    newsOption: {},
    newsOptionItems: [],
    isCommentMore: true,
    isMore: true,
    offset: 0,
    limit: 8,
    commentNumber: 0,
    isLogin: false,
    isLang: false,
    isBottom: false,
    isJoinActivity: true
  };

  computed = {};

  methods = {
    selectContent(e) {
      var that = this;
      if (e.currentTarget.dataset.set == this.isRed) return;
      this.isRed = !this.isRed;
      if (this.isRed == false) {
        this.isPut = true;
      }
      if (this.isFixed == true) {
        if (this.isRed == true) {
          this.top = that.scrollHeight;
        } else {
          this.top = that.scrollHeight + 0.1;
        }
      }
    },
    putContact() {
      if (
        wx.getStorageSync('importantInfo') == '' ||
        wx.getStorageSync('importantInfo') == undefined
      ) {
        wx.navigateTo({
          url: '/pages/login'
        });
        return;
      }
    },
    async getSelect() {
      if (
        wx.getStorageSync('importantInfo') == '' ||
        wx.getStorageSync('importantInfo') == undefined
      ) {
        wx.navigateTo({
          url: '/pages/login'
        });
        return;
      }
      if (this.isSollect == false) {
        collection(
          {
            relationId: this.activityId,
            relationType: 'activity',
            status: 'ADD_FAVORITE',
            userId: wx.getStorageSync('importantInfo').userId
          },
          this.language
        ).then(res => {
          if (res.status == 'ADD_FAVORITE') {
            this.option.likeNumber++;
            this.isSollect = true;
            this.$apply();
          }
        });
      } else {
        cancelCollection(
          {
            relationId: this.activityId,
            relationType: 'activity',
            status: 'CANCEL_FAVORITE',
            userId: wx.getStorageSync('importantInfo').userId
          },
          this.language
        ).then(res => {
          if (res == '') {
            this.option.likeNumber--;
            this.isSollect = false;
            this.$apply();
          }
        });
      }
    },
    openReplay() {
      if (
        wx.getStorageSync('importantInfo') == '' ||
        wx.getStorageSync('importantInfo') == undefined
      ) {
        wx.navigateTo({
          url: '/pages/login'
        });
        return;
      }
      this.isReplay = true;
      this.replayData = {
        parent_id: '',
        relationType: 'activity',
        production: this.option.name,
        relationId: this.activityId
      };
    },
    navigateto() {
      if (
        wx.getStorageSync('importantInfo') == '' ||
        wx.getStorageSync('importantInfo') == undefined
      ) {
        wx.navigateTo({
          url: '/pages/login'
        });
        return;
      }
      if (this.activityIsEnd == true || this.isJoinActivity == false) {
        return;
      }
      wx.navigateTo({
        url: 'oderCategory?id=' + this.activityId
      });
    },
    toMap() {
      wx.openLocation({
        latitude: Number(this.option.latNum),
        longitude: Number(this.option.lngNum),
        scale: '14',
        name: this.option.name,
        address: this.option.naddress
      });
    },
    scroll(e) {
      if (e.detail.deltaY < 0) {
        this.isPut = false;
      } else {
        this.isPut = true;
      }
      var system;
      if (e.detail.scrollTop > this.scrollHeight) {
        // wx.getSystemInfo({
        //   success: res => {
        //     system = res.system.slice(0, 3);
        //   }
        // });
        // if (system == 'iOS' && this.isBottom == true) {
        //   return;
        // }
        this.isFixed = true;
      } else {
        this.isFixed = false;
        this.isBottom = false;
      }
    },
    imgErr(e) {
      this.option.cover = 'http://pc1u34h1m.bkt.clouddn.com/defult.png';
    },
    imgsErr(e) {
      this.option.introduction[e.currentTarget.dataset.set].content =
        'http://pc1u34h1m.bkt.clouddn.com/defult.png';
    },
    async scrolltolower() {
      this.isBottom = true;
      if (this.isMore == false || this.isRed == true) return;
      await this.getRelation(true);
    }
  };

  events = {
    async closeReplay(status) {
      this.isReplay = false;
      if (status == false) return;
      await this.getRelation(false);
    },
    openCommentReplay(id, title) {
      this.$broadcast('reportReview', id, title);
      this.isReportOpen = true;
    },
    closeReport() {
      this.isReportOpen = false;
    },
    openComment(arr) {
      this.commentData = {
        nickName: arr[1],
        parent_id: arr[0],
        relationType: 'review',
        production: this.option.name,
        relationId: this.activityId
      };
      this.isWriteComment = true;
    },
    async closeComment(status) {
      this.isWriteComment = false;
      if (status == false) return;
      await this.getRelation(false);
    }
  };

  onShareAppMessage() {
    return {
      title: this.option.title,
      path: '/pages/activity/activityDetail?id=' + this.activityId
    };
  }

  async getRelation(status) {
    await relationList(
      {
        relationType: 'activity',
        relationId: this.activityId,
        limit: this.limit,
        offset: this.offset
      },
      this.language
    ).then(res => {
      for (var i = 0; i < res.items.length; i++) {
        if (this.language == 'ZH') {
          res.items[i].createTime = getTime.getZHymd(res.items[i].createTime);
        } else {
          res.items[i].createTime = getTime.getENymd(res.items[i].createTime);
        }
      }
      if (status == true) {
        this.offset += res.items.length;
      }
      if (this.limit > res.items.length) {
        this.isMore = false;
      } else {
        this.isMore = true;
      }
      if (this.offset <= 8) {
        this.newsOptionItems = res.items;
      } else {
        this.newsOptionItems = this.newsOptionItems.concat(res.items);
      }
      this.newsOption = res;
      this.$apply();
    });
  }

  async init() {
    var that = this;
    var language = wx.getStorageSync('language');
    this.$broadcast('CL', true);
    wx.getSystemInfo({
      success: function(res) {
        that.scrollHeight = 848 / 750 * res.windowWidth;
      }
    });
    await activityDetail(this.activityId, language).then(res => {
      this.option = res;
      var endTime = new Date(this.option.activityEndTime);
      var activityEndTime = new Date(this.option.endTime);
      if (endTime <= new Date()) {
        this.activityIsEnd = true;
      }
      if (activityEndTime <= new Date()) {
        this.isJoinActivity = false;
      }
      if (this.language == 'ZH') {
        this.option.activityStartTime = getTime.getZHymd(
          this.option.activityStartTime,
          false
        );
        this.option.activityEndTime = getTime.getZHymd(
          this.option.activityEndTime,
          false
        );
      } else {
        this.option.activityStartTime = getTime.getENymd(
          this.option.activityStartTime,
          false
        );
        this.option.activityEndTime = getTime.getENymd(
          this.option.activityEndTime,
          false
        );
      }
      if (
        this.option.activityStartTime.length +
          this.option.activityEndTime.length >=
        36
      ) {
        this.isLang = true;
      }
      try {
        this.option.introduction = JSON.parse(res.introduction);
      } catch (err) {
        this.option.introduction = [];
      }
      wx.setNavigationBarTitle({
        title: this.option.name
      });
      if (this.option.favoriteId > 0) {
        this.isSollect = true;
      } else {
        this.isSollect = false;
      }
      this.$apply();
    });
  }
  async onShow() {
    if (
      wx.getStorageSync('importantInfo') == '' ||
      wx.getStorageSync('importantInfo') == undefined
    ) {
      this.isLogin = true;
    } else {
      this.isLogin = false;
    }
    await this.getRelation(false);
    this.$apply();
  }
  async onLoad(e) {
    this.activityId = e.id;
    this.language = wx.getStorageSync('language');
    wx.showLoading({
      title: this.language == 'ZH' ? '数据加载中' : 'Loading',
      mask: true
    });
    await this.init();
    wx.hideLoading();
  }
}
</script>